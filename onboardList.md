# 性能与稳定性优化清单（Onboard List）

以下是从 MVP 走向测试网/上线前的性能与稳定性提升清单，按优先级排序（高 → 低）。

## P0 必做（确保不会漏单/错单）

- **WS 断线重连 + 退避**：保证实时监听长期稳定；断线时自动重连并回补最近区块。
- **小窗口回补**：每次启动/重连后回补最近 N 个区块，避免 WS 丢失。
- **幂等保护**：同一 `txHash` 不重复发放（DB 唯一约束 + 业务层判断）。
- **订单状态一致性**：状态转移有清晰路径（created → paid/paid_late_repriced/underpaid/overpaid）。

## P1 高优先（性能与吞吐）

- **pending 地址缓存**：把待支付订单地址放入内存集合，减少每笔交易查 DB。
- **批量处理**：同一区块/同批 tx 统一解析，批量写库。
- **限制 backfill 范围**：避免大范围 tx_search 带来的高延迟。
- **优化 tx_search 查询**：尽量使用节点支持的条件，减少返回量。

## P2 中优先（可观测与运维）

- **结构化日志**：记录处理耗时、pending 数量、WS 重连次数。
- **关键指标**：
  - 每分钟扫描区块数
  - 每分钟处理交易数
  - pending 订单数
  - tx_search 平均耗时
  - WS 断线次数
- **告警策略**：pending 长时间不归零、WS 频繁断线、回补耗时异常。

## P3 预留（高负载与扩展）

- **独立 indexer**：避免依赖 RPC 节点的 tx_search 负载。
- **多节点容灾**：RPC/WS 多 endpoint 轮询或自动切换。
- **并行 worker**：按地址 hash 分片处理（水平扩展）。

---

建议先完成 P0 + P1，即可支撑测试网及早期上线阶段；P2/P3 可作为稳定运营阶段的优化方向。
